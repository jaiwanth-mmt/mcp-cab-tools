MOCK_CAB_DB = {
    ("igi airport", "connaught place"): [
        {"cab_id": "DEL_IGI_CP_1", "cab_type": "mini", "price": 450},
        {"cab_id": "DEL_IGI_CP_2", "cab_type": "sedan", "price": 650},
        {"cab_id": "DEL_IGI_CP_3", "cab_type": "suv", "price": 900},
    ],
    ("delhi airport", "connaught place"): [
        {"cab_id": "DEL_AP_CP_1", "cab_type": "mini", "price": 450},
        {"cab_id": "DEL_AP_CP_2", "cab_type": "sedan", "price": 650},
        {"cab_id": "DEL_AP_CP_3", "cab_type": "suv", "price": 900},
    ],
    ("connaught place", "delhi airport"): [
        {"cab_id": "CP_DEL_AP_1", "cab_type": "mini", "price": 450},
        {"cab_id": "CP_DEL_AP_2", "cab_type": "sedan", "price": 650},
        {"cab_id": "CP_DEL_AP_3", "cab_type": "suv", "price": 900},
    ],
    ("igi airport", "gurgaon"): [
        {"cab_id": "DEL_IGI_GUR_1", "cab_type": "mini", "price": 600},
        {"cab_id": "DEL_IGI_GUR_2", "cab_type": "sedan", "price": 850},
        {"cab_id": "DEL_IGI_GUR_3", "cab_type": "suv", "price": 1200},
    ],
    ("delhi airport", "cyber city"): [
        {"cab_id": "DEL_AP_CYB_1", "cab_type": "mini", "price": 600},
        {"cab_id": "DEL_AP_CYB_2", "cab_type": "sedan", "price": 850},
        {"cab_id": "DEL_AP_CYB_3", "cab_type": "suv", "price": 1200},
    ],
    ("gurgaon", "delhi airport"): [
        {"cab_id": "GUR_DEL_AP_1", "cab_type": "mini", "price": 600},
        {"cab_id": "GUR_DEL_AP_2", "cab_type": "sedan", "price": 850},
        {"cab_id": "GUR_DEL_AP_3", "cab_type": "suv", "price": 1200},
    ],
    ("igi airport", "noida"): [
        {"cab_id": "DEL_IGI_NOI_1", "cab_type": "mini", "price": 700},
        {"cab_id": "DEL_IGI_NOI_2", "cab_type": "sedan", "price": 950},
        {"cab_id": "DEL_IGI_NOI_3", "cab_type": "suv", "price": 1300},
    ],
    ("delhi airport", "noida sector 62"): [
        {"cab_id": "DEL_AP_NOI62_1", "cab_type": "mini", "price": 700},
        {"cab_id": "DEL_AP_NOI62_2", "cab_type": "sedan", "price": 950},
        {"cab_id": "DEL_AP_NOI62_3", "cab_type": "suv", "price": 1300},
    ],
    ("noida", "delhi airport"): [
        {"cab_id": "NOI_DEL_AP_1", "cab_type": "mini", "price": 700},
        {"cab_id": "NOI_DEL_AP_2", "cab_type": "sedan", "price": 950},
        {"cab_id": "NOI_DEL_AP_3", "cab_type": "suv", "price": 1300},
    ],
    ("igi airport", "new delhi railway station"): [
        {"cab_id": "DEL_IGI_NDLS_1", "cab_type": "mini", "price": 500},
        {"cab_id": "DEL_IGI_NDLS_2", "cab_type": "sedan", "price": 700},
        {"cab_id": "DEL_IGI_NDLS_3", "cab_type": "suv", "price": 950},
    ],
    ("delhi airport", "railway station"): [
        {"cab_id": "DEL_AP_RS_1", "cab_type": "mini", "price": 500},
        {"cab_id": "DEL_AP_RS_2", "cab_type": "sedan", "price": 700},
        {"cab_id": "DEL_AP_RS_3", "cab_type": "suv", "price": 950},
    ],
    ("new delhi railway station", "connaught place"): [
        {"cab_id": "NDLS_CP_1", "cab_type": "auto", "price": 150},
        {"cab_id": "NDLS_CP_2", "cab_type": "mini", "price": 250},
        {"cab_id": "NDLS_CP_3", "cab_type": "sedan", "price": 400},
    ],
    ("connaught place", "gurgaon"): [
        {"cab_id": "CP_GUR_1", "cab_type": "mini", "price": 500},
        {"cab_id": "CP_GUR_2", "cab_type": "sedan", "price": 700},
        {"cab_id": "CP_GUR_3", "cab_type": "suv", "price": 1000},
    ],
    ("delhi", "noida"): [
        {"cab_id": "DEL_NOI_1", "cab_type": "mini", "price": 450},
        {"cab_id": "DEL_NOI_2", "cab_type": "sedan", "price": 650},
        {"cab_id": "DEL_NOI_3", "cab_type": "suv", "price": 900},
    ],
    ("delhi", "delhi"): [
        {"cab_id": "DEL_INTRA_1", "cab_type": "auto", "price": 180},
        {"cab_id": "DEL_INTRA_2", "cab_type": "mini", "price": 300},
        {"cab_id": "DEL_INTRA_3", "cab_type": "sedan", "price": 500},
    ],

    ("kempegowda airport", "electronic city"): [
        {"cab_id": "BLR_KEM_EC_1", "cab_type": "mini", "price": 800},
        {"cab_id": "BLR_KEM_EC_2", "cab_type": "sedan", "price": 1100},
        {"cab_id": "BLR_KEM_EC_3", "cab_type": "suv", "price": 1500},
    ],
    ("bangalore airport", "electronic city"): [
        {"cab_id": "BLR_AP_EC_1", "cab_type": "mini", "price": 800},
        {"cab_id": "BLR_AP_EC_2", "cab_type": "sedan", "price": 1100},
        {"cab_id": "BLR_AP_EC_3", "cab_type": "suv", "price": 1500},
    ],
    ("electronic city", "bangalore airport"): [
        {"cab_id": "EC_BLR_AP_1", "cab_type": "mini", "price": 800},
        {"cab_id": "EC_BLR_AP_2", "cab_type": "sedan", "price": 1100},
        {"cab_id": "EC_BLR_AP_3", "cab_type": "suv", "price": 1500},
    ],
    ("kempegowda airport", "whitefield"): [
        {"cab_id": "BLR_KEM_WF_1", "cab_type": "mini", "price": 650},
        {"cab_id": "BLR_KEM_WF_2", "cab_type": "sedan", "price": 900},
        {"cab_id": "BLR_KEM_WF_3", "cab_type": "suv", "price": 1250},
    ],
    ("bangalore airport", "itpl"): [
        {"cab_id": "BLR_AP_ITPL_1", "cab_type": "mini", "price": 650},
        {"cab_id": "BLR_AP_ITPL_2", "cab_type": "sedan", "price": 900},
        {"cab_id": "BLR_AP_ITPL_3", "cab_type": "suv", "price": 1250},
    ],
    ("whitefield", "bangalore airport"): [
        {"cab_id": "WF_BLR_AP_1", "cab_type": "mini", "price": 650},
        {"cab_id": "WF_BLR_AP_2", "cab_type": "sedan", "price": 900},
        {"cab_id": "WF_BLR_AP_3", "cab_type": "suv", "price": 1250},
    ],
    ("kempegowda airport", "koramangala"): [
        {"cab_id": "BLR_KEM_KOR_1", "cab_type": "mini", "price": 750},
        {"cab_id": "BLR_KEM_KOR_2", "cab_type": "sedan", "price": 1000},
        {"cab_id": "BLR_KEM_KOR_3", "cab_type": "suv", "price": 1400},
    ],
    ("bangalore airport", "koramangala"): [
        {"cab_id": "BLR_AP_KOR_1", "cab_type": "mini", "price": 750},
        {"cab_id": "BLR_AP_KOR_2", "cab_type": "sedan", "price": 1000},
        {"cab_id": "BLR_AP_KOR_3", "cab_type": "suv", "price": 1400},
    ],
    ("koramangala", "bangalore airport"): [
        {"cab_id": "KOR_BLR_AP_1", "cab_type": "mini", "price": 750},
        {"cab_id": "KOR_BLR_AP_2", "cab_type": "sedan", "price": 1000},
        {"cab_id": "KOR_BLR_AP_3", "cab_type": "suv", "price": 1400},
    ],
    ("kempegowda airport", "mg road"): [
        {"cab_id": "BLR_KEM_MG_1", "cab_type": "mini", "price": 700},
        {"cab_id": "BLR_KEM_MG_2", "cab_type": "sedan", "price": 950},
        {"cab_id": "BLR_KEM_MG_3", "cab_type": "suv", "price": 1300},
    ],
    ("bangalore airport", "indiranagar"): [
        {"cab_id": "BLR_AP_IND_1", "cab_type": "mini", "price": 700},
        {"cab_id": "BLR_AP_IND_2", "cab_type": "sedan", "price": 950},
        {"cab_id": "BLR_AP_IND_3", "cab_type": "suv", "price": 1300},
    ],
    ("bangalore city railway station", "electronic city"): [
        {"cab_id": "BLR_RS_EC_1", "cab_type": "mini", "price": 500},
        {"cab_id": "BLR_RS_EC_2", "cab_type": "sedan", "price": 700},
        {"cab_id": "BLR_RS_EC_3", "cab_type": "suv", "price": 950},
    ],
    ("electronic city", "whitefield"): [
        {"cab_id": "EC_WF_1", "cab_type": "mini", "price": 600},
        {"cab_id": "EC_WF_2", "cab_type": "sedan", "price": 850},
        {"cab_id": "EC_WF_3", "cab_type": "suv", "price": 1150},
    ],
    ("koramangala", "indiranagar"): [
        {"cab_id": "KOR_IND_1", "cab_type": "auto", "price": 120},
        {"cab_id": "KOR_IND_2", "cab_type": "mini", "price": 250},
        {"cab_id": "KOR_IND_3", "cab_type": "sedan", "price": 400},
    ],
    ("bangalore", "bangalore"): [
        {"cab_id": "BLR_INTRA_1", "cab_type": "auto", "price": 150},
        {"cab_id": "BLR_INTRA_2", "cab_type": "mini", "price": 280},
        {"cab_id": "BLR_INTRA_3", "cab_type": "sedan", "price": 450},
    ],

    ("netaji subhas airport", "salt lake sector v"): [
        {"cab_id": "CCU_NS_SL5_1", "cab_type": "mini", "price": 350},
        {"cab_id": "CCU_NS_SL5_2", "cab_type": "sedan", "price": 500},
        {"cab_id": "CCU_NS_SL5_3", "cab_type": "suv", "price": 700},
    ],
    ("kolkata airport", "salt lake"): [
        {"cab_id": "CCU_AP_SL_1", "cab_type": "mini", "price": 350},
        {"cab_id": "CCU_AP_SL_2", "cab_type": "sedan", "price": 500},
        {"cab_id": "CCU_AP_SL_3", "cab_type": "suv", "price": 700},
    ],
    ("salt lake", "kolkata airport"): [
        {"cab_id": "SL_CCU_AP_1", "cab_type": "mini", "price": 350},
        {"cab_id": "SL_CCU_AP_2", "cab_type": "sedan", "price": 500},
        {"cab_id": "SL_CCU_AP_3", "cab_type": "suv", "price": 700},
    ],
    ("netaji subhas airport", "park street"): [
        {"cab_id": "CCU_NS_PS_1", "cab_type": "mini", "price": 400},
        {"cab_id": "CCU_NS_PS_2", "cab_type": "sedan", "price": 550},
        {"cab_id": "CCU_NS_PS_3", "cab_type": "suv", "price": 750},
    ],
    ("kolkata airport", "park street"): [
        {"cab_id": "CCU_AP_PS_1", "cab_type": "mini", "price": 400},
        {"cab_id": "CCU_AP_PS_2", "cab_type": "sedan", "price": 550},
        {"cab_id": "CCU_AP_PS_3", "cab_type": "suv", "price": 750},
    ],
    ("park street", "kolkata airport"): [
        {"cab_id": "PS_CCU_AP_1", "cab_type": "mini", "price": 400},
        {"cab_id": "PS_CCU_AP_2", "cab_type": "sedan", "price": 550},
        {"cab_id": "PS_CCU_AP_3", "cab_type": "suv", "price": 750},
    ],
    ("kolkata airport", "howrah station"): [
        {"cab_id": "CCU_AP_HWH_1", "cab_type": "mini", "price": 450},
        {"cab_id": "CCU_AP_HWH_2", "cab_type": "sedan", "price": 600},
        {"cab_id": "CCU_AP_HWH_3", "cab_type": "suv", "price": 800},
    ],
    ("howrah station", "kolkata airport"): [
        {"cab_id": "HWH_CCU_AP_1", "cab_type": "mini", "price": 450},
        {"cab_id": "HWH_CCU_AP_2", "cab_type": "sedan", "price": 600},
        {"cab_id": "HWH_CCU_AP_3", "cab_type": "suv", "price": 800},
    ],
    ("howrah station", "salt lake"): [
        {"cab_id": "HWH_SL_1", "cab_type": "mini", "price": 350},
        {"cab_id": "HWH_SL_2", "cab_type": "sedan", "price": 500},
        {"cab_id": "HWH_SL_3", "cab_type": "suv", "price": 700},
    ],
    ("sealdah station", "park street"): [
        {"cab_id": "SDAH_PS_1", "cab_type": "auto", "price": 120},
        {"cab_id": "SDAH_PS_2", "cab_type": "mini", "price": 250},
        {"cab_id": "SDAH_PS_3", "cab_type": "sedan", "price": 400},
    ],
    ("salt lake", "park street"): [
        {"cab_id": "SL_PS_1", "cab_type": "mini", "price": 300},
        {"cab_id": "SL_PS_2", "cab_type": "sedan", "price": 450},
        {"cab_id": "SL_PS_3", "cab_type": "suv", "price": 650},
    ],
    ("kolkata", "kolkata"): [
        {"cab_id": "CCU_INTRA_1", "cab_type": "auto", "price": 130},
        {"cab_id": "CCU_INTRA_2", "cab_type": "mini", "price": 250},
        {"cab_id": "CCU_INTRA_3", "cab_type": "sedan", "price": 400},
    ],

    ("rajiv gandhi airport", "hitec city"): [
        {"cab_id": "HYD_RGI_HIT_1", "cab_type": "mini", "price": 650},
        {"cab_id": "HYD_RGI_HIT_2", "cab_type": "sedan", "price": 900},
        {"cab_id": "HYD_RGI_HIT_3", "cab_type": "suv", "price": 1250},
    ],
    ("hyderabad airport", "gachibowli"): [
        {"cab_id": "HYD_AP_GAC_1", "cab_type": "mini", "price": 650},
        {"cab_id": "HYD_AP_GAC_2", "cab_type": "sedan", "price": 900},
        {"cab_id": "HYD_AP_GAC_3", "cab_type": "suv", "price": 1250},
    ],
    ("hitec city", "hyderabad airport"): [
        {"cab_id": "HIT_HYD_AP_1", "cab_type": "mini", "price": 650},
        {"cab_id": "HIT_HYD_AP_2", "cab_type": "sedan", "price": 900},
        {"cab_id": "HIT_HYD_AP_3", "cab_type": "suv", "price": 1250},
    ],
    ("gachibowli", "hyderabad airport"): [
        {"cab_id": "GAC_HYD_AP_1", "cab_type": "mini", "price": 650},
        {"cab_id": "GAC_HYD_AP_2", "cab_type": "sedan", "price": 900},
        {"cab_id": "GAC_HYD_AP_3", "cab_type": "suv", "price": 1250},
    ],
    ("rajiv gandhi airport", "banjara hills"): [
        {"cab_id": "HYD_RGI_BAN_1", "cab_type": "mini", "price": 600},
        {"cab_id": "HYD_RGI_BAN_2", "cab_type": "sedan", "price": 850},
        {"cab_id": "HYD_RGI_BAN_3", "cab_type": "suv", "price": 1200},
    ],
    ("hyderabad airport", "banjara hills"): [
        {"cab_id": "HYD_AP_BAN_1", "cab_type": "mini", "price": 600},
        {"cab_id": "HYD_AP_BAN_2", "cab_type": "sedan", "price": 850},
        {"cab_id": "HYD_AP_BAN_3", "cab_type": "suv", "price": 1200},
    ],
    ("banjara hills", "hyderabad airport"): [
        {"cab_id": "BAN_HYD_AP_1", "cab_type": "mini", "price": 600},
        {"cab_id": "BAN_HYD_AP_2", "cab_type": "sedan", "price": 850},
        {"cab_id": "BAN_HYD_AP_3", "cab_type": "suv", "price": 1200},
    ],
    ("rajiv gandhi airport", "secunderabad station"): [
        {"cab_id": "HYD_RGI_SEC_1", "cab_type": "mini", "price": 550},
        {"cab_id": "HYD_RGI_SEC_2", "cab_type": "sedan", "price": 800},
        {"cab_id": "HYD_RGI_SEC_3", "cab_type": "suv", "price": 1100},
    ],
    ("hyderabad airport", "secunderabad"): [
        {"cab_id": "HYD_AP_SEC_1", "cab_type": "mini", "price": 550},
        {"cab_id": "HYD_AP_SEC_2", "cab_type": "sedan", "price": 800},
        {"cab_id": "HYD_AP_SEC_3", "cab_type": "suv", "price": 1100},
    ],
    ("rajiv gandhi airport", "madhapur"): [
        {"cab_id": "HYD_RGI_MAD_1", "cab_type": "mini", "price": 650},
        {"cab_id": "HYD_RGI_MAD_2", "cab_type": "sedan", "price": 900},
        {"cab_id": "HYD_RGI_MAD_3", "cab_type": "suv", "price": 1250},
    ],
    ("hyderabad airport", "madhapur"): [
        {"cab_id": "HYD_AP_MAD_1", "cab_type": "mini", "price": 650},
        {"cab_id": "HYD_AP_MAD_2", "cab_type": "sedan", "price": 900},
        {"cab_id": "HYD_AP_MAD_3", "cab_type": "suv", "price": 1250},
    ],
    ("secunderabad station", "hitec city"): [
        {"cab_id": "SEC_HIT_1", "cab_type": "mini", "price": 400},
        {"cab_id": "SEC_HIT_2", "cab_type": "sedan", "price": 600},
        {"cab_id": "SEC_HIT_3", "cab_type": "suv", "price": 850},
    ],
    ("secunderabad", "gachibowli"): [
        {"cab_id": "SEC_GAC_1", "cab_type": "mini", "price": 400},
        {"cab_id": "SEC_GAC_2", "cab_type": "sedan", "price": 600},
        {"cab_id": "SEC_GAC_3", "cab_type": "suv", "price": 850},
    ],
    ("hitec city", "kukatpally"): [
        {"cab_id": "HIT_KUK_1", "cab_type": "mini", "price": 350},
        {"cab_id": "HIT_KUK_2", "cab_type": "sedan", "price": 500},
        {"cab_id": "HIT_KUK_3", "cab_type": "suv", "price": 700},
    ],
    ("banjara hills", "hitec city"): [
        {"cab_id": "BAN_HIT_1", "cab_type": "mini", "price": 300},
        {"cab_id": "BAN_HIT_2", "cab_type": "sedan", "price": 450},
        {"cab_id": "BAN_HIT_3", "cab_type": "suv", "price": 650},
    ],
    ("hyderabad", "hyderabad"): [
        {"cab_id": "HYD_INTRA_1", "cab_type": "auto", "price": 140},
        {"cab_id": "HYD_INTRA_2", "cab_type": "mini", "price": 270},
        {"cab_id": "HYD_INTRA_3", "cab_type": "sedan", "price": 450},
    ],

    ("delhi", "jaipur"): [
        {"cab_id": "INTER_DEL_JAI_1", "cab_type": "sedan", "price": 3500},
        {"cab_id": "INTER_DEL_JAI_2", "cab_type": "suv", "price": 4500},
        {"cab_id": "INTER_DEL_JAI_3", "cab_type": "prime sedan", "price": 5000},
    ],
    ("jaipur", "delhi"): [
        {"cab_id": "INTER_JAI_DEL_1", "cab_type": "sedan", "price": 3500},
        {"cab_id": "INTER_JAI_DEL_2", "cab_type": "suv", "price": 4500},
        {"cab_id": "INTER_JAI_DEL_3", "cab_type": "prime sedan", "price": 5000},
    ],
    ("delhi", "agra"): [
        {"cab_id": "INTER_DEL_AGR_1", "cab_type": "sedan", "price": 3000},
        {"cab_id": "INTER_DEL_AGR_2", "cab_type": "suv", "price": 4000},
        {"cab_id": "INTER_DEL_AGR_3", "cab_type": "prime sedan", "price": 4500},
    ],
    ("agra", "delhi"): [
        {"cab_id": "INTER_AGR_DEL_1",  "cab_type": "sedan", "price": 3000},
        {"cab_id": "INTER_AGR_DEL_2", "cab_type": "suv", "price": 4000},
        {"cab_id": "INTER_AGR_DEL_3", "cab_type": "prime sedan", "price": 4500},
    ],
    ("bangalore", "mysore"): [
        {"cab_id": "INTER_BLR_MYS_1", "cab_type": "sedan", "price": 2200},
        {"cab_id": "INTER_BLR_MYS_2", "cab_type": "suv", "price": 3000},
        {"cab_id": "INTER_BLR_MYS_3", "cab_type": "prime sedan", "price": 3500},
    ],
    ("mysore", "bangalore"): [
        {"cab_id": "INTER_MYS_BLR_1", "cab_type": "sedan", "price": 2200},
        {"cab_id": "INTER_MYS_BLR_2", "cab_type": "suv", "price": 3000},
        {"cab_id": "INTER_MYS_BLR_3", "cab_type": "prime sedan", "price": 3500},
    ],
    ("hyderabad", "vijayawada"): [
        {"cab_id": "INTER_HYD_VIJ_1", "cab_type": "sedan", "price": 3200},
        {"cab_id": "INTER_HYD_VIJ_2", "cab_type": "suv", "price": 4200},
        {"cab_id": "INTER_HYD_VIJ_3", "cab_type": "prime sedan", "price": 4800},
    ],
    ("vijayawada", "hyderabad"): [
        {"cab_id": "INTER_VIJ_HYD_1", "cab_type": "sedan", "price": 3200},
        {"cab_id": "INTER_VIJ_HYD_2", "cab_type": "suv", "price": 4200},
        {"cab_id": "INTER_VIJ_HYD_3", "cab_type": "prime sedan", "price": 4800},
    ],

    ("airport", "city"): [
        {"cab_id": "FALL_AP_CT_1", "cab_type": "mini", "price": 500},
        {"cab_id": "FALL_AP_CT_2", "cab_type": "sedan", "price": 700},
        {"cab_id": "FALL_AP_CT_3", "cab_type": "suv", "price": 1000},
    ],
    ("airport", "railway station"): [
        {"cab_id": "FALL_AP_RS_1", "cab_type": "mini", "price": 450},
        {"cab_id": "FALL_AP_RS_2", "cab_type": "sedan", "price": 650},
        {"cab_id": "FALL_AP_RS_3", "cab_type": "suv", "price": 900},
    ],
    ("airport", "hotel"): [
        {"cab_id": "FALL_AP_HTL_1", "cab_type": "mini", "price": 400},
        {"cab_id": "FALL_AP_HTL_2", "cab_type": "sedan", "price": 550},
        {"cab_id": "FALL_AP_HTL_3", "cab_type": "suv", "price": 800},
    ],
    ("railway station", "hotel"): [
        {"cab_id": "FALL_RS_HTL_1", "cab_type": "auto", "price": 180},
        {"cab_id": "FALL_RS_HTL_2", "cab_type": "mini", "price": 300},
        {"cab_id": "FALL_RS_HTL_3", "cab_type": "sedan", "price": 450},
    ],
}


from datetime import datetime , timedelta , date
import random
from models.models import HoldCabRequest , HoldCabResponse
from services.storage import (
    load_holds, save_holds,
    load_payments, save_payments,
    load_passengers, save_passengers
)

BOOKING_HOLDS = load_holds()
HOLD_COUNTER = max([int(h.split('_')[1]) for h in BOOKING_HOLDS.keys()] + [1000])

def generate_hold_id()->str:
    global HOLD_COUNTER
    HOLD_COUNTER += 1
    return f"HOLD_{HOLD_COUNTER}"

def get_cab_by_id(cab_id: str)->dict:
    for route, cabs in MOCK_CAB_DB.items():
        for cab in cabs:
            if cab["cab_id"] == cab_id:
                return {
                    'cab_id': cab['cab_id'],
                    'cab_type': cab['cab_type'],
                    'price': cab['price'],
                    'route': f"{route[0]} â†’ {route[1]}"
                }
    return None

def create_booking_hold(cab_id:str , pickup:str , drop:str , departure_date:date)->dict:
    cab_details = get_cab_by_id(cab_id)
    if not cab_details:
        return None
    hold_id = generate_hold_id()
    current_time = datetime.now()
    expiry_time = current_time + timedelta(minutes=15)
    hold_data = {
        'hold_id': hold_id,
        'cab_id': cab_id,
        'status': 'held',
        'cab_details': cab_details,
        'price': cab_details['price'],
        'pickup_location': pickup,
        'drop_location': drop,
        'departure_date': departure_date,
        'created_at': current_time,
        'expires_at': expiry_time,
        'updated_at': current_time
    }
    BOOKING_HOLDS[hold_id] = hold_data
    save_holds(BOOKING_HOLDS)
    return hold_data

def get_booking_hold(hold_id: str)->dict:
    global BOOKING_HOLDS
    BOOKING_HOLDS = load_holds()
    return BOOKING_HOLDS.get(hold_id) or None

def is_hold_expired(hold_id: str)->bool:
    hold = get_booking_hold(hold_id)
    if not hold:
        return True
    if hold['expires_at'] < datetime.now():
        BOOKING_HOLDS[hold_id]['status'] = 'expired'
        return True  
    return False  

def cleanup_expired_holds():
    current_time = datetime.now()
    expired_count = 0
    grace_period = timedelta(hours=1)
    
    holds_to_delete = []
    for hold_id, hold in BOOKING_HOLDS.items():
        if hold['expires_at'] < current_time and hold['status'] == 'held':
            BOOKING_HOLDS[hold_id]['status'] = 'expired'
            expired_count += 1
        elif hold['status'] == 'expired' and hold['expires_at'] < (current_time - grace_period):
            holds_to_delete.append(hold_id)
    
    for hold_id in holds_to_delete:
        del BOOKING_HOLDS[hold_id]
        if hold_id in PASSENGER_DATA:
            del PASSENGER_DATA[hold_id]
    
    return expired_count


PASSENGER_DATA = load_passengers()

def add_passenger_to_hold(hold_id: str , passenger_details: dict)->dict:
    global BOOKING_HOLDS, PASSENGER_DATA
    BOOKING_HOLDS = load_holds()
    PASSENGER_DATA = load_passengers()
    
    hold = get_booking_hold(hold_id)
    if not hold:
        raise ValueError(f"Hold not found: {hold_id}")
    current_time = datetime.now()
    if hold['expires_at'] < current_time:
        BOOKING_HOLDS[hold_id]['status'] = 'expired'
        save_holds(BOOKING_HOLDS)
        raise ValueError(f"Hold has expired at {hold['expires_at'].isoformat()}")
    
    
    if hold['status'] not in ['held', 'passenger_added']:
        raise ValueError(f"Hold is in invalid state: {hold['status']}")
    
    PASSENGER_DATA[hold_id] = {
        'passenger_name': passenger_details['passenger_name'],
        'passenger_phone': passenger_details['passenger_phone'],
        'passenger_email': passenger_details.get('passenger_email'),
        'special_requests': passenger_details.get('special_requests'),
        'added_at': datetime.now()
    }
    
    BOOKING_HOLDS[hold_id]['status'] = 'passenger_added'
    BOOKING_HOLDS[hold_id]['updated_at'] = datetime.now()
    BOOKING_HOLDS[hold_id]['passenger_details'] = PASSENGER_DATA[hold_id]
    
    save_holds(BOOKING_HOLDS)
    save_passengers(PASSENGER_DATA)
    
    return BOOKING_HOLDS[hold_id]

def get_passenger_details(hold_id: str) -> dict:
    return PASSENGER_DATA.get(hold_id)

def has_passenger_details(hold_id: str) -> bool:
    return hold_id in PASSENGER_DATA


PAYMENT_SESSIONS = load_payments()
PAYMENT_COUNTER = max([int(p.split('_')[1]) for p in PAYMENT_SESSIONS.keys()] + [5000])

def generate_payment_session_id() -> str:
    global PAYMENT_COUNTER
    PAYMENT_COUNTER += 1
    return f"PAY_{PAYMENT_COUNTER}"


def create_payment_session(hold_id: str, amount: float) -> dict:
    global BOOKING_HOLDS, PAYMENT_SESSIONS
    BOOKING_HOLDS = load_holds()
    PAYMENT_SESSIONS = load_payments()
    
    hold = get_booking_hold(hold_id)
    if not hold:
        raise ValueError(f"Hold not found: {hold_id}")
    
    if is_hold_expired(hold_id):
        raise ValueError(f"Hold has expired")
    
    if hold['status'] not in ['passenger_added', 'payment_pending']:
        raise ValueError(f"Hold must have passenger details before payment. Current status: {hold['status']}")
    
    session_id = generate_payment_session_id()
    current_time = datetime.now()
    expiry_time = current_time + timedelta(minutes=30)
    
    payment_data = {
        'session_id': session_id,
        'hold_id': hold_id,
        'amount': amount,
        'status': 'pending',
        'created_at': current_time,
        'expires_at': expiry_time,
        'completed_at': None,
        'card_last4': None
    }
    
    PAYMENT_SESSIONS[session_id] = payment_data
    
    BOOKING_HOLDS[hold_id]['status'] = 'payment_pending'
    BOOKING_HOLDS[hold_id]['updated_at'] = current_time
    
    save_payments(PAYMENT_SESSIONS)
    save_holds(BOOKING_HOLDS)
    
    return payment_data


def get_payment_session(session_id: str) -> dict:
    global PAYMENT_SESSIONS
    PAYMENT_SESSIONS = load_payments()
    return PAYMENT_SESSIONS.get(session_id)


def update_payment_status(session_id: str, status: str, card_last4: str = None) -> dict:
    global BOOKING_HOLDS, PAYMENT_SESSIONS
    BOOKING_HOLDS = load_holds()
    PAYMENT_SESSIONS = load_payments()
    
    session = get_payment_session(session_id)
    if not session:
        raise ValueError(f"Payment session not found: {session_id}")
    
    if session['status'] == 'completed':
        raise ValueError("Payment already completed")
    
    if session['expires_at'] < datetime.now():
        session['status'] = 'failed'
        save_payments(PAYMENT_SESSIONS)
        raise ValueError("Payment session has expired")
    
    current_time = datetime.now()
    session['status'] = status
    session['completed_at'] = current_time if status == 'completed' else None
    session['card_last4'] = card_last4
    
    hold_id = session['hold_id']
    if hold_id in BOOKING_HOLDS:
        if status == 'completed':
            BOOKING_HOLDS[hold_id]['status'] = 'payment_success'
        elif status == 'failed':
            BOOKING_HOLDS[hold_id]['status'] = 'payment_pending'
        BOOKING_HOLDS[hold_id]['updated_at'] = current_time
    
    save_payments(PAYMENT_SESSIONS)
    save_holds(BOOKING_HOLDS)
    
    return session


def get_payment_by_hold(hold_id: str) -> dict:
    for session in PAYMENT_SESSIONS.values():
        if session['hold_id'] == hold_id and session['status'] == 'completed':
            return session
    return None


MOCK_DRIVERS = [
    {
        "name": "Rajesh Kumar",
        "phone": "+91-9876543210",
        "vehicle_number": "DL-01-AB-1234",
        "vehicle_model": "Honda City",
        "rating": 4.8
    },
    {
        "name": "Amit Singh",
        "phone": "+91-9876543211",
        "vehicle_number": "DL-02-CD-5678",
        "vehicle_model": "Maruti Suzuki Dzire",
        "rating": 4.7
    },
    {
        "name": "Suresh Patel",
        "phone": "+91-9876543212",
        "vehicle_number": "DL-03-EF-9012",
        "vehicle_model": "Toyota Innova",
        "rating": 4.9
    },
    {
        "name": "Vijay Sharma",
        "phone": "+91-9876543213",
        "vehicle_number": "DL-04-GH-3456",
        "vehicle_model": "Hyundai Creta",
        "rating": 4.6
    },
    {
        "name": "Kiran Reddy",
        "phone": "+91-9876543214",
        "vehicle_number": "KA-05-IJ-7890",
        "vehicle_model": "Honda City",
        "rating": 4.8
    },
    {
        "name": "Pradeep Nair",
        "phone": "+91-9876543215",
        "vehicle_number": "KA-06-KL-1234",
        "vehicle_model": "Maruti Swift",
        "rating": 4.5
    },
    {
        "name": "Ravi Verma",
        "phone": "+91-9876543216",
        "vehicle_number": "MH-07-MN-5678",
        "vehicle_model": "Toyota Etios",
        "rating": 4.7
    },
    {
        "name": "Manoj Gupta",
        "phone": "+91-9876543217",
        "vehicle_number": "UP-08-OP-9012",
        "vehicle_model": "Honda Amaze",
        "rating": 4.6
    },
    {
        "name": "Deepak Joshi",
        "phone": "+91-9876543218",
        "vehicle_number": "RJ-09-QR-3456",
        "vehicle_model": "Hyundai Verna",
        "rating": 4.8
    },
    {
        "name": "Anil Mehta",
        "phone": "+91-9876543219",
        "vehicle_number": "GJ-10-ST-7890",
        "vehicle_model": "Maruti Ciaz",
        "rating": 4.9
    }
]

BOOKING_COUNTER = 2000


def generate_booking_id() -> str:
    global BOOKING_COUNTER
    BOOKING_COUNTER += 1
    return f"BKG_{BOOKING_COUNTER}"


def assign_driver_to_booking(hold_id: str) -> dict:
    hold = get_booking_hold(hold_id)
    if not hold:
        raise ValueError(f"Hold not found: {hold_id}")
    
    if hold['status'] != 'payment_success':
        raise ValueError(f"Payment not completed for this hold. Current status: {hold['status']}")
    
    driver = random.choice(MOCK_DRIVERS)
    return driver.copy()


def confirm_booking_final(hold_id: str, driver: dict) -> dict:
    global BOOKING_HOLDS
    BOOKING_HOLDS = load_holds()
    
    hold = get_booking_hold(hold_id)
    if not hold:
        raise ValueError(f"Hold not found: {hold_id}")
    
    if hold['status'] != 'payment_success':
        raise ValueError(f"Cannot confirm booking. Payment not completed. Status: {hold['status']}")
    
    booking_id = generate_booking_id()
    current_time = datetime.now()
    
    BOOKING_HOLDS[hold_id]['status'] = 'confirmed'
    BOOKING_HOLDS[hold_id]['booking_id'] = booking_id
    BOOKING_HOLDS[hold_id]['driver'] = driver
    BOOKING_HOLDS[hold_id]['confirmed_at'] = current_time
    BOOKING_HOLDS[hold_id]['updated_at'] = current_time
    
    save_holds(BOOKING_HOLDS)
    
    return BOOKING_HOLDS[hold_id]